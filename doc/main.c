#include "15W4Kxxxx.h"
#include "oled.c"
#include "bmp.h"
sbit l=P0^4;
sbit r=P5^2;
int ls;
int rs;
int n;
int wall=0;
int xh=0;
int yh=0;
void delay1s(void);
int length=4;
int i;
int flag=1;
int n=0;
int count=0;
sbit p70=P7^0;
sbit p71=P7^1;
sbit p72=P7^2;
sbit p73=P7^3;
unsigned char p_m;
unsigned char m_m;
unsigned char i_m=0;
unsigned char n_m=0;
unsigned char code xiaoge[]={0x2c,0x18,0x2c,0x48,0x27,0x18,0x2c,0x24,0x32,0xc,0x35,0x18,0x3b,0x18,0x43,
	0x48,0x3b,0x18,0x59,0x30,0xff,0xff,0xff,0xff,0xff,0x59,0x18,0x4f,0x30,0x59,0x30,0x43,0x24,0x35,0xc,
	0x2c,0x18,0x35,0x18,0x27,0x90,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x2c,0x48,0x27,0x18,
	0x2c,0x30,0x35,0x24,0x43,0xc,0x3b,0x30,0x35,0x18,0x2c,0x18,0x3b,0x30,0xff,0xff,0xff,0xff,0xff,0x2c,
	0x18,0x2c,0x30,0x27,0x18,0x2c,0x24,0x32,0xc,0x35,0x18,0x3b,0x18,0x43,0x24,0x43,0xc,0x43,0x18,0x3b,
	0x18,0x59,0x30,0xff,0xff,0xff,0xff,0xff,0x4f,0x30,0x59,0x18,0x59,0x18,0x43,0x24,0x35,0xc,0x2c,0x18,
	0x27,0x18,0x35,0x90,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x2c,0x18,0x2c,0x30,0x27,0x18,
	0x2c,0x48,0x35,0x18,0x3b,0x30,0x35,0x18,0x27,0x18,0x2c,0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0x35,0x30,0x35,0x18,0x35,0x18,0x35,0x18,0x35,0x30,0x35,0x18,0x3b,0x24,0x35,0xc,0x3b,0x18,
	0x43,0x18,0x4f,0x30,0xff,0xff,0xff,0xff,0xff,0x59,0x18,0x43,0x24,0x35,0xc,0x2c,0x18,0x27,0x18,0x2c,
	0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3b,0x24,0x35,0xc,0x3b,0x18,0x43,0x18,0x3b,
	0x30,0xff,0xff,0xff,0xff,0xff,0x59,0x18,0x35,0x24,0x35,0xc,0x35,0x18,0x35,0xc,0x3b,0x30,0x35,0x30,
	0x3b,0x24,0x35,0xc,0x3b,0x18,0x43,0x18,0x4f,0x30,0xff,0xff,0xff,0xff,0xff,0x59,0x18,0x2c,0x24,0x2c,
	0xc,0x2c,0x18,0x2c,0x18,0x27,0x30,0x27,0x18,0x27,0x18,0x2c,0x30,0x3b,0x30,0x2c,0x60,0x27,0x24,0x27,
	0xc,0x2c,0x18,0x27,0x18,0x35,0x30,0x3b,0x24,0x2c,0xc,0x35,0x18,0x43,0x18,0x3b,0x30,0x59,0x18,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x43,0x18,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0x2c,0x18,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x35,0x18,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0x3b,0x24,0x3b,0xc,0x27,0x30,0x2c,0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0x27,0x18,0x27,0x30,0x27,0x18,0x2c,0x30,0x27,0x30,0x2c,0x30,0x35,0x18,0x43,0x18,0x3b,
	0x30,0x4f,0x18,0x59,0x18,0x43,0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x3b,0x30,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x35,0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0x2c,0x30,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x27,0x90,0x27,0x30,0x2c,0x90,0X00};	 //music 
unsigned char code erquanyingyue[]={0x43,0x48,0x4f,0x24,0x43,0x24,0x35,0x48,0x35,0x24,0x3b,0x24,0x43,0x48,
	4f,0x24,0x43,0x36,0x3b,0x12,0x35,0x24,0x35,0x32,0x3b,0x48,0x43,0x36,0x43,0x12,0x4f,0x24,0x43,0x24,0x3b,
	0x24,0x35,0x24,0x35,0x24,0x59,0x120,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x35,0x9,0x2c,0x24,0xff,
	0xff,0xff,0xff,0x35,0x24,0x2c,0x24,0x27,0x24,0x2c,0x24,0x27,0x24,0x21,0x24,0x2c,0x6c,0x35,0x24,0x2c,
	0x24,0x2c,0x48,0x21,0x24,0x27,0x48,0x27,0x48,0x2c,0x24,0x27,0x24,0x2c,0x24,0x2c,0x24,0x35,0x6c,0x59,
	0x24,0x35,0x48,0x35,0x24,0x2c,0x24,0x3b,0x36,0x35,0x12,0x3b,0x24,0x43,0x24,0x4f,0x24,0x43,0x24,0x4f,
	0x48,0x43,0xfc,0x3b,0x24,0x35,0x24,0x2c,0x24,0x43,0x48,0x3b,0x24,0x2c,0x24,0x35,0x24,0x27,0x24,0x2c,
	0x120,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
	0xff,0xff,0xff,0xff,0X00};
int direction=4;
int cordinate_X=9;
int cordinate_Y=5;
unsigned char x[50]={4,3,2,1};
unsigned char y[50]={2,2,2,2};
void move();
void key();
int rand();
void showscore();
void generate(int);
void timer_init();
void int0();
int j;
int judge();
void delay();
sbit s1=P0^0;sbit s2=P0^1;sbit s3=P0^2;sbit s4=P0^3;
int te;
sbit Beep=P0^6;
void delay_m(unsigned char);
void delayms_m(unsigned char a_m)
{
int temporary=100*a_m;
   while(--temporary);
}
unsigned char code seg7[16]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x98,0x88,0x83,0xc6,0xa1,0x86,0x82};//diaplay 0123456789AbCdEF
int main(void)
{
P0M0=0X00;P0M1=0X00;
P5M0=0X00;P5M1=0X00;	
P7M0=0X00;P7M1=0X00;	 //P7¶Ë¿ÚÄ£Ê½Éè¶¨
P1M0=0X00;P1M1=0X00;   //P1¶Ë¿ÚÄ£Ê½Éè¶¨
P2M0=0X00;P2M1=0X00;  
P4M0=0X1E;P4M1=0X00;    //initiate number display
P0M0=0X00;P0M1=0X00;
P0M0=0x40;P0M1=0x00;    //initiate beep
restart:OLED_Init();			//³õÊ¼»¯OLED  
OLED_Clear();
timer_init();
OLED_ShowString(24,0,"select mode");
OLED_ShowString(10,2,"switch 0:fast");
OLED_ShowString(10,4,"switch 1:slow");
while(1)
{
	if(s1==0||s2==0)
	{
		if(s1==0)n=30;
		if(s2==0)n=60;
		break;
	} 

}
OLED_ShowString(24,0,"select mode");
OLED_ShowString(10,2,"switch 2:wall");
OLED_ShowString(10,4,"switch 3: no wall");
while(1)
{
if(s3==0||s4==0)
	{
		if(s3==0)wall=1;
		if(s4==0)wall=0;
		break;
	} 
}
OLED_Clear();
while(1) 
{	
		
	OLED_Clear();
	if(wall==1) 
	{
	for(i=0;i<16;i++)
	{OLED_DrawBMP(8*i,0,8*i+8,1,BMP9);OLED_DrawBMP(8*i,7,8*i+8,8,BMP9);}
	for(i=0;i<8;i++)
	{OLED_DrawBMP(0,i,8,i+1,BMP8);OLED_DrawBMP(119,i,127,i+1,BMP8);}
	}
	for(i=1;i<length;i++)
	OLED_DrawBMP(8*x[i],y[i],8*x[i]+8,y[i]+1,BMP6);
	OLED_DrawBMP(8*x[0],y[0],8*x[0]+8,y[0]+1,BMP10);
	generate(flag);
	OLED_DrawBMP(8*cordinate_X,cordinate_Y,8*cordinate_X+8,cordinate_Y+1,BMP7);
	delay1s();
	move();
	if(judge()==1)
	{
		i_m=0;
		OLED_Clear();
		OLED_ShowString(24,4,"Game over!");
		OLED_ShowString(24,6,"Score:");
		OLED_ShowChar(72,6,(length-4)/10+48);
		OLED_ShowChar(80,6,(length-4)%10+48);
	 	//showscore();
		
		play:
   while(1)
   {
   	//OLED_Clear();OLED_ShowChar(72,6,(count)/10+48);
	//	OLED_ShowChar(80,6,(count)%10+48);
   if(s1==1&&s2==1&&s3==1&&s4==1)
		{
		length=4;
		y[0]=2;y[1]=2;y[3]=2;y[4]=2;
		x[0]=4;x[1]=3;x[3]=2;x[4]=1;  direction=4;
		goto restart;
		}
	if(count<50&&length<10)
	   {OLED_Clear();OLED_ShowString(24,2,"you lose!");OLED_ShowString(12,4,"turn switch off");OLED_ShowString(24,6,"to restart");p70=~p70;p71=~p71;p72=~p72;p73=~p73;}
	if(count<50&&length>=10)
	   {OLED_Clear();OLED_ShowString(0,2,"you reached the goal");OLED_ShowString(0,4,"turn switch off");OLED_ShowString(24,6,"to restart");p70=~p70;p71=~p71;p72=~p72;p73=~p73;}
	if(count>50&&length>=10)
	   {OLED_Clear();OLED_DrawBMP(0,0,128,8,BMP4);p70=~p70;p71=~p71;p72=~p72;p73=~p73;} 
	if(length>=10) 
	{
    a1:p_m=xiaoge[i_m];
	  
	  if(p_m==0x00)
	  {
	    i_m=0,delayms_m(1000);goto play;
	  }
	  else if(p_m==0xff)
	  {
	    i_m=i_m+1;delayms_m(1000),TR0=0;goto a1;
	  }
	  else
	  {
	    m_m=xiaoge[i_m++],n_m=xiaoge[i_m++];
	  }
	  TR0=1;
	  
	
	  while(n_m!=0)
	      Beep=~Beep,delay_m(2*m_m);
	  TR0=0;
	}  
	else
	{
	   a2:p_m=erquanyingyue[i_m];
	  
	  if(p_m==0x00)
	  {
	    i_m=0,delayms_m(1000);goto play;
	  }
	  else if(p_m==0xff)
	  {
	    i_m=i_m+1;delayms_m(1000),TR0=0;goto a2;
	  }
	  else
	  {
	    m_m=erquanyingyue[i_m++],n_m=erquanyingyue[i_m++];
	  }
	  TR0=1;	  
	  while(n_m!=0)
	      Beep=~Beep,delay_m(2*m_m);
	  TR0=0;
	}
	}
	}
}
}	  
	

void delay1s(void)
{ 
unsigned char i,j,k;
for(i=n;i>0;i--)     
for(j=25;j>0;j--)    
for(k=1;k>0;k--)
showscore();   
   
}
/*
void draw(void)
{
int i=0,j=0;
for(i=0;i<16;i++)
	for(j=0;j<8;j++)
		{
		if(cordinate[i][j])
			OLED_DrawBMP(8*i,j,8*i+8,j+1,BMP6);
		}
}  
*/

/*void key()
{
	if(l==0){direction++;while(l==0)showscore();if(direction==0)direction=4;
	 if(direction==5)direction=1;goto end;}
	 else if(r==0){direction--;while(r==0)showscore();if(direction==0)direction=4;
	 if(direction==5)direction=1;goto end;}
	 else delay1s();
	end: if(direction==0)direction=4;
	 if(direction==5)direction=1;
}*/
void move()
{
	xh=x[0];
	yh=y[0];
	switch(direction)
	{
	case 1:yh--;break;
	case 2:xh--;break;
	case 3:yh++;break;
	case 4:xh++;break;
	}
	for(i=length-1;i>=1;i--)
	{	
	x[i]=x[i-1];
	y[i]=y[i-1];
	}
	if(wall==0){
	if(xh>15)xh=0;
	else if(xh<0)xh=15;
	if(yh>8)yh=0;
	else if(yh<0)yh=7;}
	x[0]=xh;y[0]=yh;
	
} 
void generate(int p)
{	   
if(p==0)
{
back:	cordinate_X=rand()%16;
		i=100;while(i--);								// delay to generate different rand()
		cordinate_Y=rand()%8;
		for(i=0;i<length;i++)
			if(x[i]==cordinate_X&&y[i]==cordinate_Y)	 //avoid generating on the snake
					goto back;
		if(wall==1)
			if(cordinate_X==0||cordinate_X==15||cordinate_Y<=1||cordinate_Y>=7)	  //avoid generating on the edge
			goto back;				   
flag=1;				  				           
}
}
int judge()
{  
	for(i=1;i<length;i++)
		if(x[i]==x[0]&&y[i]==y[0])   //hit itself
			return 1;
	if(x[0]==cordinate_X&&y[0]==cordinate_Y)   
	{
			flag=0;
			length++;
	for(i=length-1;i>=1;i--)
	{	
			x[i]=x[i-1];
			y[i]=y[i-1];
	}
	}
	if(wall==1)
	{
	if(x[0]<=0||x[0]>=15)return 1;
	if(y[0]<=0||y[0]>=7)return 1;
	}
	
	return 0;  
}
int rand()
{
	return(TL0);
}
void timer_init()
{
	TMOD=0X03;	//timer t0 to count
	TL0=0X00;	//low:starting value
	TH0=0X00;
	TL1=0Xef;
	TH1=0Xd8;	//high:starting value
	EA=1;	//allow interrupt
	ET0=1;  //timer0 can interrupt
	ET1=1;	
	TR0=1;  //set mode:start counting
	TR1=1; 
}
void key0() interrupt 1    //timer 0 interrupts at 0 while timer1 interrupts at 3
{
	TH0=0x3c;
	TL0=0XB0;
	count++;
	if(count>=100)count=0;
	
	if(l==0){direction++;while(l==0)showscore();if(direction==0)direction=4;
	 if(direction==5)direction=1;goto end;}
	 else if(r==0){direction--;while(r==0)showscore();if(direction==0)direction=4;
	 if(direction==5)direction=1;goto end;}
	end: if(direction==0)direction=4;
	 if(direction==5)direction=1;
}

void showscore()
{
	int t,a,b;
	t=length-4;
	a=t%10;t=t/10;
	b=t%10;t=t/10;
	P2=seg7[b];
	P4=0x04;
	delay();			 
	P2=seg7[a];
	P4=0x02;
	delay(); 			
}
void delay(void)
{
   unsigned char i,j,k;
   for(i=3;i>0;i--)    
   for(j=14;j>0;j--)    
   for(k=1;k>0;k--);    
}

void int0() interrupt 3
{
   TH1=0xd8;
   TL1=0xef;
   n_m--;
}
void delay_m(unsigned char m_m)
{
 unsigned i_m=2*m_m;
//	unsigned i=m;
   while(--i_m);
}
